<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PowerShell Script Manager</title>
  <!-- Include TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include our shared CSS -->
  <link rel="stylesheet" href="../assets/css/main.css">
  <!-- Include Monaco Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.30.1/min/vs/loader.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6', // blue-500
            powershell: {
              blue: '#0078d7',
              dark: '#012456'
            }
          }
        }
      }
    }
  </script>
  <style>
    .editor-container {
      height: 400px;
      border: 1px solid #ddd;
      border-radius: 0.375rem;
    }
    
    .dark .editor-container {
      border-color: #4b5563;
    }
    
    .terminal {
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 14px;
      padding: 12px;
      color: #eee;
      background-color: #012456;
      border-radius: 0.375rem;
      overflow: auto;
      white-space: pre-wrap;
      height: 300px;
    }
    
    .terminal .success { color: #10B981; }
    .terminal .error { color: #EF4444; }
    .terminal .info { color: #60A5FA; }
    .terminal .warning { color: #F59E0B; }
    .terminal .command { color: #9CA3AF; font-style: italic; }
    
    .spinner {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="theme-powershell-tool">
  <div class="container mx-auto py-6 px-4 max-w-6xl">
    <!-- Header -->
    <div class="tool-header">
      <div>
        <h1 class="tool-title">PowerShell Script Manager</h1>
        <p class="tool-description">Create, edit, and run PowerShell scripts</p>
      </div>
      <a href="../dashboard/dashboard.html" class="back-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        Back to Dashboard
      </a>
    </div>
    
    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column: Script List -->
      <div class="col-span-1">
        <div class="card mb-4">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Scripts</h2>
            <div class="flex space-x-2">
              <button id="newScriptBtn" class="p-1 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" title="New Script">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
              </button>
              <button id="uploadScriptBtn" class="p-1 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" title="Upload Script">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              </button>
              <input type="file" id="scriptFileInput" accept=".ps1" class="hidden">
            </div>
          </div>
          
          <!-- Search -->
          <div class="mb-4">
            <div class="relative">
              <input id="scriptSearch" type="text" placeholder="Search scripts..." class="input pl-10">
              <div class="absolute left-3 top-2.5 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>
          </div>
          
          <!-- Script List -->
          <div id="scriptList" class="max-h-96 overflow-y-auto">
            <!-- Scripts will be loaded here via JavaScript -->
            <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-8">No scripts yet. Create a new script or upload one.</div>
          </div>
        </div>
        
        <!-- Script Parameters -->
        <div class="card">
          <h2 class="text-lg font-semibold mb-4">Parameters</h2>
          
          <!-- Parameter Form -->
          <div id="parameterForm" class="space-y-4">
            <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-4">No parameters defined.</div>
          </div>
        </div>
      </div>
      
      <!-- Right Column: Script Editor and Terminal -->
      <div class="col-span-1 lg:col-span-2">
        <!-- Script Editor -->
        <div class="card mb-6">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center">
              <input id="scriptName" type="text" class="text-lg font-semibold bg-transparent border-b border-transparent hover:border-gray-300 dark:hover:border-gray-600 focus:border-blue-500 dark:focus:border-blue-400 focus:outline-none" placeholder="Script Name" value="New Script">
              <span class="text-gray-400 ml-1">.ps1</span>
            </div>
            
            <div class="flex space-x-2">
              <button id="saveScriptBtn" class="btn btn-primary px-3 py-1 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" />
                </svg>
                Save
              </button>
              
              <button id="runScriptBtn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                Run
              </button>
              
              <div class="relative">
                <button id="scriptActionsBtn" class="p-1 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                  </svg>
                </button>
                <div id="scriptActionsMenu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-10 hidden">
                  <div class="py-1">
                    <button id="exportScriptBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                      Export Script
                    </button>
                    <button id="deleteScriptBtn" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                      Delete Script
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Editor -->
          <div id="editorContainer" class="editor-container">
            <!-- Monaco Editor will be mounted here -->
          </div>
          
          <!-- Add Parameter Button -->
          <div class="mt-4">
            <button id="addParamBtn" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Add Parameter
            </button>
          </div>
        </div>
        
        <!-- Terminal Output -->
        <div class="card">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Terminal Output</h2>
            <button id="clearTerminalBtn" class="px-3 py-1 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition text-sm">
              Clear
            </button>
          </div>
          <div id="terminal" class="terminal">
            <div class="info">PowerShell Terminal Simulator v1.0</div>
            <div class="command">// Run a script to see the output</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Info Section -->
    <div class="card mt-8">
      <h2 class="text-lg font-bold mb-4">PowerShell Script Manager Info</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-md font-semibold mb-2">About This Tool</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            This tool allows you to create, edit, and manage PowerShell scripts directly in your browser.
            Scripts are stored locally in your browser and can be exported as .ps1 files.
            Note that script execution is simulated for demonstration purposes.
          </p>
        </div>
        <div>
          <h3 class="text-md font-semibold mb-2">Sample Scripts</h3>
          <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400 list-disc pl-5">
            <li>SystemInfo.ps1 - Gather basic system information</li>
            <li>EventLogAnalyzer.ps1 - Analyze event logs</li>
            <li>BackupFiles.ps1 - Create file backups</li>
            <li>NetworkTest.ps1 - Test network connectivity</li>
          </ul>
        </div>
        <div>
          <h3 class="text-md font-semibold mb-2">Features</h3>
          <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400 list-disc pl-5">
            <li>PowerShell syntax highlighting</li>
            <li>Script parameter management</li>
            <li>Export scripts as .ps1 files</li>
            <li>Local storage for your scripts</li>
            <li>Simulated execution environment</li>
          </ul>
        </div>
        <div>
          <h3 class="text-md font-semibold mb-2">Helpful Resources</h3>
          <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400 list-disc pl-5">
            <li><a href="https://learn.microsoft.com/en-us/powershell/" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">PowerShell Documentation</a></li>
            <li><a href="https://github.com/PowerShell/PowerShell" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">PowerShell GitHub Repository</a></li>
            <li><a href="https://www.powershellgallery.com/" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">PowerShell Gallery</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Parameter Modal -->
  <div id="parameterModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Add Parameter</h3>
        <button id="closeParameterModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <form id="parameterModalForm" class="space-y-4">
        <div>
          <label for="paramName" class="block text-sm font-medium">Parameter Name</label>
          <input type="text" id="paramName" class="input mt-1">
        </div>
        
        <div>
          <label for="paramType" class="block text-sm font-medium">Parameter Type</label>
          <select id="paramType" class="input mt-1">
            <option value="string">String</option>
            <option value="int">Integer</option>
            <option value="bool">Boolean</option>
            <option value="datetime">DateTime</option>
            <option value="array">Array</option>
          </select>
        </div>
        
        <div>
          <label for="paramDefault" class="block text-sm font-medium">Default Value</label>
          <input type="text" id="paramDefault" class="input mt-1">
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" id="paramMandatory" class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500">
          <label for="paramMandatory" class="ml-2 block text-sm">Mandatory</label>
        </div>
        
        <div>
          <label for="paramDescription" class="block text-sm font-medium">Description</label>
          <textarea id="paramDescription" rows="3" class="textarea mt-1"></textarea>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" id="cancelParameterBtn" class="px-4 py-2 border rounded hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition">Cancel</button>
          <button type="submit" id="saveParameterBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Add Parameter</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6 mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Delete Script</h3>
        <button id="closeDeleteModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <p class="mb-6">Are you sure you want to delete this script? This action cannot be undone.</p>
      
      <div class="flex justify-end space-x-3">
        <button id="cancelDeleteBtn" class="px-4 py-2 border rounded hover:bg-gray-100 dark:border-gray-600 dark:hover:bg-gray-700 transition">Cancel</button>
        <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Delete</button>
      </div>
    </div>
  </div>

  <!-- Include shared JavaScript files -->
  <script src="../assets/js/utils.js"></script>
  
  <script>
    // Current script data
    let currentScript = {
      id: generateId(),
      name: 'New Script',
      content: '',
      parameters: [],
      lastModified: new Date()
    };

    // Monaco Editor instance
    let editor;

    // Helper Functions
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatDate(date) {
      return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).format(new Date(date));
    }

    // Initialize Monaco Editor
    function initializeEditor() {
      require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.30.1/min/vs' }});
      require(['vs/editor/editor.main'], function() {
        // Register PowerShell language
        monaco.languages.register({ id: 'powershell' });
        
        // Define PowerShell syntax highlighting rules
        monaco.languages.setMonarchTokensProvider('powershell', {
          ignoreCase: true,
          defaultToken: '',
          brackets: [
            { open: '{', close: '}', token: 'delimiter.curly' },
            { open: '[', close: ']', token: 'delimiter.square' },
            { open: '(', close: ')', token: 'delimiter.parenthesis' }
          ],
          keywords: [
            'begin', 'break', 'catch', 'class', 'continue', 'data', 'define', 'do', 'dynamicparam',
            'else', 'elseif', 'end', 'exit', 'filter', 'finally', 'for', 'foreach', 'from',
            'function', 'if', 'in', 'param', 'process', 'return', 'switch', 'throw',
            'trap', 'try', 'until', 'using', 'var', 'while', 'workflow'
          ],
          helpKeywords: [
            'describe', 'context', 'it', 'should', 'mock', 'expect'
          ],
          symbolicOperators: [
            '-', '+', '=', '+=', '-=', '*=', '/=', '%=', '*', '/', '%', '++', '--', '..', '||', '&&', 
            '|', '-and', '-or', '-not', '-like', '-notlike', '-match', '-notmatch'
          ],
          escapes: /`(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,
          tokenizer: {
            root: [
              // Comments
              [/#.*$/, 'comment'],
              [/<#/, 'comment', '@comment'],
              
              // Strings
              [/"/, { token: 'string.quote', bracket: '@open', next: '@string' }],
              [/'/, { token: 'string.quote.single', bracket: '@open', next: '@singleString' }],
              
              // Variables
              [/\$\w+/, 'variable'],
              [/\$\{.*?\}/, 'variable'],
              
              // Keywords
              [/\b(param|function|if|else|foreach|switch|while|for|do|until|try|catch|finally|break|continue|return|throw)\b/i, 'keyword'],
              
              // Cmdlets and operators
              [/\b[A-Z][\w\d]*-[A-Z][\w\d]*\b/, 'keyword.operator'],
              [/\b(Write-Host|Write-Output|Write-Error|Get-Content|Set-Content|Get-Item)\b/, 'keyword.operator'],
              [/-[a-zA-Z]+\b/, 'operator'],
              [/[=\+\-\*\/%]/, 'operator'],
              
              // Numbers
              [/\d+/, 'number'],
              
              // Identifiers
              [/[a-zA-Z_][\w]*/, 'identifier']
            ],
            comment: [
              [/#>/, 'comment', '@pop'],
              [/./, 'comment']
            ],
            string: [
              [/[^\\"]+/, 'string'],
              [/@escapes/, 'string.escape'],
              [/\\./, 'string.escape.invalid'],
              [/"/, { token: 'string.quote', bracket: '@close', next: '@pop' }]
            ],
            singleString: [
              [/[^\\']+/, 'string'],
              [/@escapes/, 'string.escape'],
              [/\\./, 'string.escape.invalid'],
              [/'/, { token: 'string.quote.single', bracket: '@close', next: '@pop' }]
            ]
          }
        });
        
        // Set editor theme based on current site theme
        const isDarkMode = document.documentElement.classList.contains('dark');
        
        // Create the editor
        editor = monaco.editor.create(document.getElementById('editorContainer'), {
          value: '',
          language: 'powershell',
          theme: isDarkMode ? 'vs-dark' : 'vs',
          automaticLayout: true,
          minimap: { enabled: false },
          scrollBeyondLastLine: false,
          fontFamily: 'Consolas, "Courier New", monospace',
          fontSize: 14,
          tabSize: 4
        });
        
        // Create a new script to start
        createNewScript();
      });
    }

    // Load scripts from localStorage
    function loadScriptsFromLocalStorage() {
      const savedScripts = localStorage.getItem('powershellScripts');
      return savedScripts ? JSON.parse(savedScripts) : [];
    }

    // Save scripts to localStorage
    function saveScriptsToLocalStorage(scripts) {
      localStorage.setItem('powershellScripts', JSON.stringify(scripts));
    }

    // Extract parameters from script content
    function extractParametersFromScript(content) {
      const parameters = [];
      const paramRegex = /\s*\[Parameter\s*\((.*?)\)\s*\]\s*\[\s*([^\]]+)\s*\]\s*\$([a-zA-Z0-9_]+)(?:\s*=\s*([^,\n]*))?/g;
      
      let match;
      while ((match = paramRegex.exec(content)) !== null) {
        const paramAttributes = match[1];
        const paramType = match[2].trim();
        const paramName = match[3].trim();
        const paramDefault = match[4] ? match[4].trim().replace(/^["']|["']$/g, '') : '';
        
        const mandatory = /Mandatory\s*=\s*\$true/i.test(paramAttributes);
        
        parameters.push({
          name: paramName,
          type: paramType.toLowerCase(),
          default: paramDefault,
          mandatory: mandatory,
          description: ''  // Can't reliably extract description from script
        });
      }
      
      return parameters;
    }

    // Save current script
    function saveScriptToLocalStorage() {
      // Update content from editor
      if (editor) {
        currentScript.content = editor.getValue();
      }
      
      // Update last modified date
      currentScript.lastModified = new Date();
      
      // Get existing scripts
      let scripts = loadScriptsFromLocalStorage();
      
      // Find if script already exists
      const existingIndex = scripts.findIndex(s => s.id === currentScript.id);
      
      // Update or add the script
      if (existingIndex !== -1) {
        scripts[existingIndex] = currentScript;
      } else {
        scripts.push(currentScript);
      }
      
      // Save to localStorage
      saveScriptsToLocalStorage(scripts);
      
      // Show feedback
      displayTerminalMessage('Script saved successfully.', 'success');
      
      // Update script list
      renderScriptList(scripts);
    }

    // Delete script from localStorage 
    function deleteScriptFromLocalStorage(scriptId) {
      // Get existing scripts
      let scripts = loadScriptsFromLocalStorage();
      
      // Filter out the script to delete
      scripts = scripts.filter(s => s.id !== scriptId);
      
      // Save back to localStorage
      saveScriptsToLocalStorage(scripts);
      
      // Create a new script if the current one was deleted
      if (currentScript.id === scriptId) {
        createNewScript();
      }
      
      // Update script list
      renderScriptList(scripts);
    }

    // Create a new script
    function createNewScript(name = 'New Script', content = '') {
      currentScript = {
        id: generateId(),
        name: name,
        content: content || `# ${name}\n# Created: ${new Date().toLocaleDateString()}\n\nparam (\n    # Define parameters here\n)\n\n# Your script code here\nWrite-Host "Hello, PowerShell!" -ForegroundColor Cyan\n`,
        parameters: [],
        lastModified: new Date()
      };
      
      const scriptName = document.getElementById('scriptName');
      scriptName.value = currentScript.name;
      
      if (editor) {
        editor.setValue(currentScript.content);
      }
      
      updateParameterForm();
      renderScriptList();
    }

    // Load a script into the editor
    function loadScript(script) {
      currentScript = JSON.parse(JSON.stringify(script)); // Deep copy
      
      const scriptName = document.getElementById('scriptName');
      scriptName.value = currentScript.name;
      
      if (editor) {
        editor.setValue(currentScript.content);
      }
      
      updateParameterForm();
      renderScriptList(); // Refresh list to update active state
    }

    // Update parameter form based on current script parameters
    function updateParameterForm() {
      const parameterForm = document.getElementById('parameterForm');
      
      if (!currentScript || !currentScript.parameters) return;
      
      parameterForm.innerHTML = '';
      
      if (currentScript.parameters.length === 0) {
        parameterForm.innerHTML = `
          <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-4">No parameters defined.</div>
        `;
        return;
      }
      
      currentScript.parameters.forEach((param, index) => {
        const paramElement = document.createElement('div');
        paramElement.className = 'mb-4 border border-gray-200 dark:border-gray-700 rounded-lg p-3';
        
        let controlHtml = '';
        
        // Create different controls based on parameter type
        if (param.type === 'bool') {
          // Boolean parameter uses a checkbox
          const isChecked = param.default === 'true' ? 'checked' : '';
          controlHtml = `
            <div class="flex items-center mt-2">
              <input type="checkbox" id="param-${index}" ${isChecked} class="rounded border-gray-300 dark:border-gray-600 text-blue-600">
              <label for="param-${index}" class="ml-2 block text-sm">${param.name}</label>
            </div>
          `;
        } else {
          // Other types use text input
          controlHtml = `
            <label for="param-${index}" class="block text-sm font-medium mb-1">${param.name} ${param.mandatory ? '<span class="text-red-500">*</span>' : ''}</label>
            <input type="text" id="param-${index}" value="${param.default || ''}" class="input">
          `;
        }
        
        paramElement.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center">
              <span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full px-2 py-0.5">${param.type}</span>
              ${param.mandatory ? '<span class="text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-full px-2 py-0.5 ml-1">required</span>' : ''}
            </div>
            <button class="delete-param-btn text-gray-400 hover:text-red-500" data-index="${index}">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          ${controlHtml}
          ${param.description ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${param.description}</p>` : ''}
        `;
        
        parameterForm.appendChild(paramElement);
      });
      
      // Add event listeners to delete buttons
      document.querySelectorAll('.delete-param-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          deleteParameter(index);
        });
      });
    }

    // Delete a parameter from the current script
    function deleteParameter(index) {
      currentScript.parameters.splice(index, 1);
      updateParameterForm();
    }

    // Add a parameter to the current script
    function addParameter(paramData) {
      if (!paramData || !paramData.name) return;
      
      currentScript.parameters.push(paramData);
      updateParameterForm();
      
      // Update script content with parameter
      injectParameterIntoScript(paramData);
    }

    // Inject parameter definition into script content
    function injectParameterIntoScript(param) {
      if (!editor) return;
      
      const content = editor.getValue();
      const lines = content.split('\n');
      
      // Find param block
      let paramBlockStart = -1;
      let paramBlockEnd = -1;
      
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].trim().startsWith('param (')) {
          paramBlockStart = i;
          break;
        }
      }
      
      if (paramBlockStart === -1) {
        // No param block found, inject one after script comments
        let insertPosition = 0;
        
        // Skip past any initial comments
        while (insertPosition < lines.length && lines[insertPosition].trim().startsWith('#')) {
          insertPosition++;
        }
        
        // Insert param block
        const paramBlock = [
          '',
          'param (',
          `    [Parameter(Mandatory=$${param.mandatory.toString()})]`,
          `    [${param.type === 'array' ? 'array' : param.type === 'int' ? 'int' : 'string'}]$${param.name}${param.default ? ` = "${param.default}"` : ''}`,
          ')',
          ''
        ];
        
        lines.splice(insertPosition, 0, ...paramBlock);
      } else {
        // Find end of param block
        for (let i = paramBlockStart + 1; i < lines.length; i++) {
          if (lines[i].trim() === ')') {
            paramBlockEnd = i;
            break;
          }
        }
        
        if (paramBlockEnd === -1) {
          // Couldn't find end, assume next line
          paramBlockEnd = paramBlockStart + 1;
        }
        
        // Insert parameter before the closing parenthesis
        const paramLines = [
          `    [Parameter(Mandatory=$${param.mandatory.toString()})]`,
          `    [${param.type === 'array' ? 'array' : param.type === 'int' ? 'int' : 'string'}]$${param.name}${param.default ? ` = "${param.default}"` : ''},`
        ];
        
        lines.splice(paramBlockEnd, 0, ...paramLines);
      }
      
      // Update editor content
      editor.setValue(lines.join('\n'));
    }

    // Render the list of scripts
    function renderScriptList(scripts = null) {
      const scriptList = document.getElementById('scriptList');
      
      // Load scripts from local storage if not provided
      if (!scripts) {
        scripts = loadScriptsFromLocalStorage();
      }
      
      const searchTerm = document.getElementById('scriptSearch').value.toLowerCase();
      
      // Filter scripts by search term
      let filteredScripts = scripts;
      if (searchTerm) {
        filteredScripts = scripts.filter(script => 
          script.name.toLowerCase().includes(searchTerm)
        );
      }
      
      // Sort scripts by last modified (newest first)
      filteredScripts.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
      
      // Clear the list
      scriptList.innerHTML = '';
      
      if (filteredScripts.length === 0) {
        scriptList.innerHTML = `
          <div class="text-gray-500 dark:text-gray-400 text-sm text-center py-8">
            No scripts found. Create a new script or upload one.
          </div>
        `;
        return;
      }
      
      // Render each script
      filteredScripts.forEach(script => {
        const isActive = currentScript && script.id === currentScript.id;
        
        const scriptItem = document.createElement('div');
        scriptItem.className = `p-2 mb-2 rounded-lg cursor-pointer ${
          isActive ? 'bg-blue-100 dark:bg-blue-900' : 'hover:bg-gray-100 dark:hover:bg-gray-800'
        }`;
        
        scriptItem.innerHTML = `
          <div class="font-medium">${script.name}.ps1</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${formatDate(script.lastModified)}</div>
        `;
        
        scriptItem.addEventListener('click', () => {
          loadScript(script);
        });
        
        scriptList.appendChild(scriptItem);
      });
    }

    // Display a message in the terminal
    function displayTerminalMessage(message, type = 'info') {
      const terminal = document.getElementById('terminal');
      const messageElement = document.createElement('div');
      messageElement.className = type;
      messageElement.textContent = message;
      terminal.appendChild(messageElement);
      terminal.scrollTop = terminal.scrollHeight;
    }

    // Simulate script execution
    function simulateScriptExecution() {
      if (!editor) {
        displayTerminalMessage('Editor not initialized.', 'error');
        return;
      }
      
      const scriptContent = editor.getValue();
      if (!scriptContent.trim()) {
        displayTerminalMessage('Script is empty.', 'error');
        return;
      }
      
      // Disable run button during execution
      const runButton = document.getElementById('runScriptBtn');
      const originalButtonContent = runButton.innerHTML;
      runButton.disabled = true;
      runButton.innerHTML = `
        <svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Running...
      `;
      
      displayTerminalMessage('', 'info');
      displayTerminalMessage(`Executing script: ${currentScript.name}.ps1...`, 'info');
      displayTerminalMessage(`Started at: ${new Date().toLocaleTimeString()}`, 'info');
      displayTerminalMessage('', 'command');
      
      // Get parameter values
      const paramValues = {};
      currentScript.parameters.forEach((param, index) => {
        const paramElement = document.getElementById(`param-${index}`);
        if (paramElement) {
          if (param.type === 'bool') {
            paramValues[param.name] = paramElement.checked;
          } else {
            paramValues[param.name] = paramElement.value;
          }
        }
      });
      
      // Show parameter values in terminal
      if (Object.keys(paramValues).length > 0) {
        displayTerminalMessage('Parameters:', 'info');
        for (const [key, value] of Object.entries(paramValues)) {
          displayTerminalMessage(`  $${key}: ${value}`, 'command');
        }
        displayTerminalMessage('', 'command');
      }
      
      // Parse script to find Write-Host commands
      const lines = scriptContent.split('\n');
      
      // Simulate progressive output
      let currentLine = 0;
      const maxLines = 100; // Limit to prevent infinite loops
      
      const processNextLine = () => {
        if (currentLine >= lines.length || currentLine > maxLines) {
          // Script finished
          runButton.disabled = false;
          runButton.innerHTML = originalButtonContent;
          displayTerminalMessage('', 'command');
          displayTerminalMessage(`Script execution completed at: ${new Date().toLocaleString()}`, 'success');
          return;
        }
        
        const line = lines[currentLine].trim();
        currentLine++;
        
        // Simulation delay
        const delay = Math.random() * 300 + 100; // 100-400ms delay between lines
        
        setTimeout(() => {
          // Process line based on PowerShell commands
          if (line.match(/^Write-Host\s+["']/i)) {
            // Extract message and color from Write-Host
            const match = line.match(/^Write-Host\s+["'](.+?)["'](?:.*?-ForegroundColor\s+([a-zA-Z]+))?/i);
            
            if (match) {
              const message = match[1];
              let messageType = 'info';
              
              // Map PowerShell colors to our terminal classes
              if (match[2]) {
                const color = match[2].toLowerCase();
                if (color === 'red') messageType = 'error';
                else if (color === 'yellow') messageType = 'warning';
                else if (color === 'green') messageType = 'success';
                else if (color === 'cyan' || color === 'blue') messageType = 'info';
              }
              
              displayTerminalMessage(message, messageType);
            }
          } else if (line.match(/^Write-Error\s+["']/i)) {
            // Extract error message
            const match = line.match(/^Write-Error\s+["'](.+?)["']/i);
            
            if (match) {
              displayTerminalMessage(match[1], 'error');
            }
          } else if (line.match(/^Write-Warning\s+["']/i)) {
            // Extract warning message
            const match = line.match(/^Write-Warning\s+["'](.+?)["']/i);
            
            if (match) {
              displayTerminalMessage(match[1], 'warning');
            }
          } else if (line.match(/^#/)) {
            // Comments - occasionally show them
            if (Math.random() < 0.2) {
              displayTerminalMessage(line, 'command');
            }
          } else if (line.match(/Start-Sleep/i)) {
            // Simulate longer delay for Sleep commands
            return setTimeout(processNextLine, 800);
          }
          
          processNextLine();
        }, delay);
      };
      
      // Start processing lines
      processNextLine();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize theme
      themeUtils.initTheme();
      
      // Initialize editor
      initializeEditor();
      
      // Load saved scripts
      const scripts = loadScriptsFromLocalStorage();
      renderScriptList(scripts);
      
      // Event handlers for UI elements
      document.getElementById('newScriptBtn').addEventListener('click', () => {
        createNewScript();
      });
      
      document.getElementById('uploadScriptBtn').addEventListener('click', () => {
        document.getElementById('scriptFileInput').click();
      });
      
      document.getElementById('scriptFileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const content = e.target.result;
            createNewScript(file.name.replace('.ps1', ''), content);
          };
          reader.readAsText(file);
        }
      });
      
      document.getElementById('saveScriptBtn').addEventListener('click', () => {
        // Update script name from input
        currentScript.name = document.getElementById('scriptName').value;
        saveScriptToLocalStorage();
      });
      
      document.getElementById('runScriptBtn').addEventListener('click', () => {
        simulateScriptExecution();
      });
      
      document.getElementById('clearTerminalBtn').addEventListener('click', () => {
        const terminal = document.getElementById('terminal');
        terminal.innerHTML = `
          <div class="info">PowerShell Terminal Simulator v1.0</div>
          <div class="command">// Terminal cleared</div>
        `;
      });
      
      document.getElementById('addParamBtn').addEventListener('click', () => {
        const parameterModal = document.getElementById('parameterModal');
        
        // Reset form fields
        document.getElementById('paramName').value = '';
        document.getElementById('paramType').value = 'string';
        document.getElementById('paramDefault').value = '';
        document.getElementById('paramMandatory').checked = false;
        document.getElementById('paramDescription').value = '';
        
        parameterModal.classList.remove('hidden');
      });
      
      document.getElementById('parameterModalForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const paramName = document.getElementById('paramName').value.trim();
        const paramType = document.getElementById('paramType').value;
        const paramDefault = document.getElementById('paramDefault').value.trim();
        const paramMandatory = document.getElementById('paramMandatory').checked;
        const paramDescription = document.getElementById('paramDescription').value.trim();
        
        if (!paramName) return;
        
        addParameter({
          name: paramName,
          type: paramType,
          default: paramDefault,
          mandatory: paramMandatory,
          description: paramDescription
        });
        
        document.getElementById('parameterModal').classList.add('hidden');
      });
      
      document.getElementById('closeParameterModal').addEventListener('click', () => {
        document.getElementById('parameterModal').classList.add('hidden');
      });
      
      document.getElementById('cancelParameterBtn').addEventListener('click', () => {
        document.getElementById('parameterModal').classList.add('hidden');
      });
      
      document.getElementById('deleteScriptBtn').addEventListener('click', () => {
        document.getElementById('deleteModal').classList.remove('hidden');
      });
      
      document.getElementById('closeDeleteModal').addEventListener('click', () => {
        document.getElementById('deleteModal').classList.add('hidden');
      });
      
      document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
        document.getElementById('deleteModal').classList.add('hidden');
      });
      
      document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
        document.getElementById('deleteModal').classList.add('hidden');
        
        if (currentScript) {
          deleteScriptFromLocalStorage(currentScript.id);
        }
      });
      
      document.getElementById('exportScriptBtn').addEventListener('click', () => {
        if (!currentScript) return;
        
        // Get current content from editor
        if (editor) {
          currentScript.content = editor.getValue();
        }
        
        // Create a blob with the script content
        const blob = new Blob([currentScript.content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        // Create a download link and trigger it
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentScript.name}.ps1`;
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        displayTerminalMessage(`Script exported as ${currentScript.name}.ps1`, 'success');
        
        // Close dropdown
        document.getElementById('scriptActionsMenu').classList.add('hidden');
      });
      
      document.getElementById('scriptActionsBtn').addEventListener('click', () => {
        document.getElementById('scriptActionsMenu').classList.toggle('hidden');
      });
      
      document.getElementById('scriptSearch').addEventListener('input', () => {
        const scripts = loadScriptsFromLocalStorage();
        renderScriptList(scripts);
      });
      
      // Close dropdown when clicking outside
      window.addEventListener('click', (e) => {
        if (!e.target.closest('#scriptActionsBtn') && !e.target.closest('#scriptActionsMenu')) {
          document.getElementById('scriptActionsMenu').classList.add('hidden');
        }
      });
    });
  </script>
</body>
</html>
